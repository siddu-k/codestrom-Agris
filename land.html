<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>BioFarm AI - Precision Mapper</title>
    <!-- Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    <!-- Leaflet CSS -->
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/leaflet.draw/1.0.4/leaflet.draw.css" />
    <!-- Marked.js for Markdown -->
    <script src="https://cdn.jsdelivr.net/npm/marked/marked.min.js"></script>
    <!-- Lucide Icons -->
    <script src="https://unpkg.com/lucide@latest"></script>
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700;800&display=swap');

        body,
        html {
            height: 100%;
            margin: 0;
            overflow: hidden;
            font-family: 'Inter', sans-serif;
        }

        #map {
            height: 100%;
            width: 100%;
            z-index: 0;
        }

        /* --- PREMIUM GLASS UI --- */
        .glass-hud {
            background: rgba(10, 15, 30, 0.85);
            backdrop-filter: blur(20px);
            -webkit-backdrop-filter: blur(20px);
            border: 1px solid rgba(255, 255, 255, 0.08);
            box-shadow: 0 8px 32px 0 rgba(0, 0, 0, 0.5);
        }

        .glass-panel {
            background: rgba(255, 255, 255, 0.03);
            border: 1px solid rgba(255, 255, 255, 0.05);
            transition: all 0.3s ease;
        }

        .glass-panel:hover {
            background: rgba(255, 255, 255, 0.06);
            border-color: rgba(16, 185, 129, 0.3);
            transform: translateY(-1px);
        }

        /* Typography */
        .text-gradient {
            background: linear-gradient(135deg, #34d399 0%, #10b981 100%);
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
        }

        /* Scrollbar */
        .custom-scroll::-webkit-scrollbar {
            width: 3px;
        }

        .custom-scroll::-webkit-scrollbar-track {
            background: transparent;
        }

        .custom-scroll::-webkit-scrollbar-thumb {
            background: rgba(16, 185, 129, 0.3);
            border-radius: 10px;
        }

        /* Animations */
        @keyframes slideIn {
            from {
                opacity: 0;
                transform: translateY(10px);
            }

            to {
                opacity: 1;
                transform: translateY(0);
            }
        }

        .animate-enter {
            animation: slideIn 0.4s ease-out forwards;
        }

        /* Left Sidebar Slide Animation */
        #left-sidebar {
            transition: transform 0.4s cubic-bezier(0.16, 1, 0.3, 1);
            z-index: 2000;
        }

        .sidebar-hidden {
            transform: translateX(-105%);
        }

        .sidebar-visible {
            transform: translateX(0);
        }

        /* Floating Chat Window Animation */
        #chat-window {
            transition: transform 0.3s cubic-bezier(0.34, 1.56, 0.64, 1), opacity 0.2s ease;
            transform-origin: bottom right;
        }

        .chat-hidden {
            transform: scale(0.9) translateY(20px);
            opacity: 0;
            pointer-events: none;
        }

        .chat-visible {
            transform: scale(1) translateY(0);
            opacity: 1;
            pointer-events: auto;
        }

        /* Leaflet Overrides */
        .leaflet-top.leaflet-right {
            margin-top: 90px;
            margin-right: 10px;
        }

        .leaflet-draw-toolbar a {
            background-color: rgba(30, 41, 59, 0.9) !important;
            border-color: rgba(255, 255, 255, 0.15) !important;
            color: #e2e8f0 !important;
        }

        .leaflet-draw-toolbar a:hover {
            background-color: #10b981 !important;
            color: white !important;
        }

        select.glass-select {
            background-image: url("data:image/svg+xml,%3csvg xmlns='http://www.w3.org/2000/svg' fill='none' viewBox='0 0 20 20'%3e%3cpath stroke='%2394a3b8' stroke-linecap='round' stroke-linejoin='round' stroke-width='1.5' d='M6 8l4 4 4-4'/%3e%3c/svg%3e");
            background-position: right 0.5rem center;
            background-repeat: no-repeat;
            background-size: 1.5em 1.5em;
            padding-right: 2.5rem;
            -webkit-print-color-adjust: exact;
        }

        /* Tooltip & HUD Styling */
        .glass-hud {
            background: rgba(30, 41, 59, 0.85) !important;
            backdrop-filter: blur(12px);
            border: 1px solid rgba(16, 185, 129, 0.25) !important;
            color: #ecfdf5 !important;
            border-radius: 8px !important;
            padding: 6px 10px !important;
            box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.3) !important;
            font-family: monospace;
            z-index: 1000;
        }

        /* Override Leaflet default tooltip styles */
        .leaflet-tooltip.glass-hud {
            box-shadow: none !important;
        }

        .leaflet-tooltip-top:before {
            display: none !important;
            /* Remove arrow */
        }

        .leaflet-tooltip-bottom:before {
            display: none !important;
            /* Remove arrow */
        }

        .leaflet-tooltip-left:before {
            display: none !important;
            /* Remove arrow */
        }

        .leaflet-tooltip-right:before {
            display: none !important;
            /* Remove arrow */
        }
    </style>
</head>

<body class="bg-slate-900 flex flex-col h-screen text-slate-100">

    <!-- Header Overlay (Floating) -->
    <header class="absolute top-4 left-4 right-4 flex justify-between items-center z-[1001] pointer-events-none">

        <!-- Brand -->
        <div class="flex items-center gap-4 glass-hud p-2.5 pr-6 rounded-full pointer-events-auto">
            <div
                class="bg-gradient-to-br from-emerald-500 to-green-600 p-2 rounded-full shadow-lg shadow-emerald-500/20">
                <i data-lucide="sprout" class="text-white w-5 h-5"></i>
            </div>
            <div class="hidden sm:block">
                <h1 class="text-sm font-bold tracking-tight text-white leading-tight">BioFarm <span
                        class="text-emerald-400">AI</span></h1>
                <p class="text-[9px] text-slate-400 font-medium uppercase tracking-widest">Precision Agriculture</p>
            </div>
        </div>

        <!-- Action Bar -->
        <div class="flex gap-3 pointer-events-auto">
            <button id="show-sidebar-btn"
                class="hidden flex items-center gap-2 glass-hud hover:bg-slate-800 px-4 py-2.5 rounded-full text-emerald-400 text-xs font-bold uppercase tracking-wider transition-all border border-emerald-500/20 hover:border-emerald-500/50">
                <i data-lucide="layout-panel-left" class="w-4 h-4"></i> <span class="hidden sm:inline">Report</span>
            </button>
            <button id="reset-btn"
                class="flex items-center gap-2 glass-hud hover:bg-slate-800 px-4 py-2.5 rounded-full text-slate-300 text-xs font-bold uppercase tracking-wider transition-all hover:text-white">
                <i data-lucide="refresh-cw" class="w-4 h-4"></i> <span class="hidden sm:inline">Clear</span>
            </button>
            <button id="analyze-btn" disabled
                class="flex items-center gap-2 px-6 py-2.5 rounded-full text-xs font-bold uppercase tracking-widest shadow-lg shadow-emerald-900/20 transition-all bg-gradient-to-r from-emerald-500 to-green-600 hover:from-emerald-400 hover:to-green-500 text-white disabled:from-slate-800 disabled:to-slate-800 disabled:text-slate-600 disabled:cursor-not-allowed disabled:shadow-none border border-transparent hover:border-emerald-300/30">
                <i data-lucide="zap" class="w-4 h-4"></i>
                <span id="analyze-text">Analyze Field</span>
            </button>
        </div>
    </header>

    <!-- Sidebar (Premium Side Panel) -->
    <aside id="left-sidebar"
        class="absolute top-4 bottom-4 left-4 w-[400px] sidebar-hidden glass-hud rounded-3xl border border-white/10 flex flex-col shadow-2xl overflow-hidden z-[2000] transition-transform duration-300">

        <!-- Sidebar Header -->
        <div class="px-6 pt-6 pb-4 border-b border-white/10 bg-white/10 backdrop-blur-md">
            <div class="flex items-center justify-between mb-4">
                <h2 class="text-sm font-bold text-white flex items-center gap-2">
                    <i data-lucide="scan-line" class="text-emerald-400 w-4 h-4"></i>
                    <span class="text-gradient">Site Analysis</span>
                </h2>
                <button id="close-sidebar"
                    class="text-slate-500 hover:text-white transition-colors bg-white/5 p-1.5 rounded-full hover:bg-white/10">
                    <i data-lucide="chevron-left" class="w-4 h-4"></i>
                </button>
            </div>

            <!-- Provider Switcher -->
            <div class="mb-4">
                <label class="text-[9px] text-slate-500 font-bold uppercase tracking-widest mb-1.5 block ml-1">AI Model
                    Provider</label>
                <div class="relative">
                    <select id="ai-provider"
                        class="glass-select appearance-none w-full bg-black/20 text-xs text-white border border-white/10 rounded-xl px-3 py-2 focus:outline-none focus:border-emerald-500/50 hover:bg-white/5 cursor-pointer font-medium">
                        <option value="openrouter" class="bg-slate-900">OpenRouter (Mimo V2 Free)</option>
                        <option value="xiaomi" class="bg-slate-900">Xiaomi Official (Mimo V2)</option>
                    </select>
                </div>
                <div id="xiaomi-notice" class="hidden mt-2 p-2 bg-blue-500/10 border border-blue-500/20 rounded-lg">
                    <p class="text-[9px] text-blue-300 leading-relaxed">
                        ðŸ’¡ <strong>Xiaomi API selected</strong><br>
                        If it fails, run: <code class="bg-black/30 px-1 rounded">start-proxy.bat</code>
                    </p>
                </div>
            </div>

            <!-- Modern Tabs -->
            <div class="flex p-1 bg-black/40 rounded-xl">
                <button id="tab-current"
                    class="flex-1 text-[10px] font-bold uppercase py-1.5 rounded-lg bg-emerald-600 text-white shadow-md transition-all">Current
                    Scan</button>
                <button id="tab-history"
                    class="flex-1 text-[10px] font-bold uppercase py-1.5 rounded-lg text-slate-500 hover:text-slate-300 transition-all">History</button>
            </div>
        </div>

        <!-- Scrollable Content Area -->
        <div class="flex-1 overflow-y-auto custom-scroll p-6 space-y-6 relative">
            <div id="sidebar-report" class="space-y-6">
                <!-- Empty State -->
                <div class="flex flex-col items-center justify-center h-40 text-center opacity-40">
                    <i data-lucide="satellite" class="w-12 h-12 mb-3 text-slate-500"></i>
                    <p class="text-xs text-slate-400 font-medium">Select an area on the map<br>and click Analyze</p>
                </div>
            </div>

            <div id="sidebar-history" class="hidden space-y-3">
                <!-- History Items -->
            </div>
        </div>

        <!-- Sidebar Footer: Chat Trigger -->
        <div class="p-4 border-t border-white/10 bg-white/10 backdrop-blur-md">
            <button id="toggle-chat-btn"
                class="w-full flex items-center justify-center gap-2 bg-emerald-500 hover:bg-emerald-400 text-white p-3 rounded-xl shadow-lg shadow-emerald-500/20 transition-all active:scale-[0.98]">
                <i data-lucide="message-square-plus" class="w-4 h-4"></i>
                <span class="text-xs font-bold uppercase tracking-wider">Discuss with AI</span>
            </button>
        </div>

    </aside>

    <!-- Side-by-Side Chat Window (Hidden by default) -->
    <div id="chat-window"
        class="absolute top-4 bottom-4 left-[432px] w-[360px] glass-hud rounded-3xl border border-white/10 flex flex-col z-[1999] chat-hidden shadow-2xl overflow-hidden transition-all duration-300 origin-left">
        <!-- Chat Header -->
        <div
            class="p-4 border-b border-white/10 bg-gradient-to-r from-emerald-900/60 to-slate-800/80 items-center justify-between flex">
            <div class="flex items-center gap-3">
                <div
                    class="w-8 h-8 rounded-full bg-emerald-500/20 flex items-center justify-center border border-white/10">
                    <i data-lucide="bot" class="w-4 h-4 text-emerald-400"></i>
                </div>
                <div>
                    <h3 class="text-sm font-bold text-white leading-tight">Assistant</h3>
                    <p class="text-[10px] text-emerald-400/80 font-medium">Context Aware</p>
                </div>
            </div>
            <button id="close-chat"
                class="text-slate-400 hover:text-white p-2 hover:bg-white/5 rounded-full transition-colors">
                <i data-lucide="x" class="w-4 h-4"></i>
            </button>
        </div>

        <!-- Chat Messages -->
        <div id="chat-box" class="flex-1 overflow-y-auto p-4 space-y-4 custom-scroll text-xs">
            <div class="flex gap-3">
                <div
                    class="w-6 h-6 rounded-full bg-emerald-500/20 flex items-center justify-center shrink-0 border border-emerald-500/30">
                    <i data-lucide="bot" class="w-3 h-3 text-emerald-400"></i>
                </div>
                <div
                    class="bg-white/10 p-3 rounded-2xl rounded-tl-none border border-white/10 text-slate-200 shadow-sm leading-relaxed">
                    I'm ready to discuss the field analysis. Ask me about the soil, crops, or irrigation strategy!
                </div>
            </div>
        </div>

        <!-- Chat Input -->
        <div class="p-4 border-t border-white/5 bg-black/20 backdrop-blur-sm">
            <div class="relative group">
                <input type="text" id="chat-input" placeholder="Type your question..."
                    class="w-full bg-slate-800/80 border border-white/10 rounded-xl py-3.5 px-4 pr-10 text-xs text-white placeholder:text-slate-400 focus:outline-none focus:border-emerald-500/50 focus:ring-1 focus:ring-emerald-500/20 transition-all shadow-inner">
                <button id="send-chat"
                    class="absolute right-2 top-2 p-1.5 text-emerald-500 hover:text-white hover:bg-emerald-500 rounded-lg transition-all">
                    <i data-lucide="arrow-up" class="w-4 h-4"></i>
                </button>
            </div>
        </div>
    </div>

    <!-- Main Map Area -->
    <main class="flex-1 relative bg-slate-900">
        <div id="map"></div>
    </main>

    <!-- Scripts -->
    <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/leaflet.draw/1.0.4/leaflet.draw.js"></script>

    <script>
        // --- CONFIG ---
        const openRouterKey = "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";
        const xiaomiKey = "sk-s4ttcbu2027lx6muwubqug09d6mxyhup9091snterjsp2q80";

        const siteUrl = "http://localhost:3000"; // Optional for OpenRouter rankings
        const siteName = "BioFarm AI"; // Optional for OpenRouter rankings

        lucide.createIcons();

        let mapInstance = null;
        let drawnItems = null;
        let currentBounds = null;
        let reportData = null; // Store current analysis for export/re-render

        function initMap() {
            // Darker tiles or standard satellite
            const googleSatellite = L.tileLayer('https://mt1.google.com/vt/lyrs=s&x={x}&y={y}&z={z}', {
                maxZoom: 21,
                attribution: '&copy; Google'
            });

            mapInstance = L.map('map', {
                zoomControl: false,
                layers: [googleSatellite]
            }).setView([20.5937, 78.9629], 5);

            L.control.zoom({ position: 'bottomright' }).addTo(mapInstance);

            drawnItems = new L.FeatureGroup();
            mapInstance.addLayer(drawnItems);

            const drawControl = new L.Control.Draw({
                position: 'topright',
                draw: {
                    polygon: { allowIntersection: false, showArea: true, shapeOptions: { color: '#10b981', fillOpacity: 0.2 } },
                    rectangle: { shapeOptions: { color: '#10b981', fillOpacity: 0.2 } },
                    circle: false, marker: true, circlemarker: false, polyline: false
                },
                edit: { featureGroup: drawnItems, remove: true }
            });
            mapInstance.addControl(drawControl);

            // Custom Locate Button
            const LocateControl = L.Control.extend({
                options: { position: 'topright' },
                onAdd: function (map) {
                    const btn = L.DomUtil.create('div', 'leaflet-bar leaflet-control');
                    btn.innerHTML = `<a href="#" style="background:#1e293b; border-color:rgba(255,255,255,0.15); color:white; display:flex; align-items:center; justify-content:center; width:34px; height:34px;"><svg width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><circle cx="12" cy="12" r="10"/><path d="M12 2a14.5 14.5 0 0 0 0 20 14.5 14.5 0 0 0 0-20"/><path d="M2 12h20"/></svg></a>`;
                    btn.onclick = (e) => {
                        e.preventDefault();
                        if ("geolocation" in navigator) {
                            navigator.geolocation.getCurrentPosition(pos => { map.flyTo([pos.coords.latitude, pos.coords.longitude], 18); });
                        }
                    };
                    return btn;
                }
            });
            mapInstance.addControl(new LocateControl());

            mapInstance.on('draw:created', function (e) {
                const layer = e.layer;
                drawnItems.clearLayers();
                drawnItems.addLayer(layer);

                // Vertex Tooltips
                if (layer instanceof L.Polygon) {
                    const latlngs = layer.getLatLngs()[0]; // Outer ring
                    latlngs.forEach(ll => {
                        const marker = L.circleMarker(ll, {
                            radius: 4,
                            color: '#10b981',
                            fillColor: '#fff',
                            fillOpacity: 1
                        });
                        marker.bindTooltip(`Lat: ${ll.lat.toFixed(4)}<br>Lon: ${ll.lng.toFixed(4)}`, {
                            permanent: false,
                            direction: 'top',
                            className: 'glass-hud text-xs'
                        });
                        drawnItems.addLayer(marker);
                    });

                    // Polygon Summary Tooltip (Hover on Center/Fill)
                    const coordList = latlngs.map((ll, i) =>
                        `<li class="flex justify-between gap-4"><span>P${i + 1}</span> <span class="font-mono opacity-80">${ll.lat.toFixed(5)}, ${ll.lng.toFixed(5)}</span></li>`
                    ).join('');

                    layer.bindTooltip(`
                        <div class="min-w-[180px]">
                            <div class="font-bold text-xs uppercase text-emerald-400 mb-1 border-b border-white/10 pb-1">Field Coordinates</div>
                            <ul class="text-[10px] space-y-0.5 max-h-[200px] overflow-y-auto custom-scrollbar">
                                ${coordList}
                            </ul>
                            <div class="text-[9px] text-slate-500 mt-2 italic text-center">Click Analyze to proceed</div>
                        </div>
                    `, {
                        direction: 'center',
                        className: 'glass-hud',
                        opacity: 1
                    });
                }

                if (layer.getBounds) currentBounds = layer.getBounds().getCenter();
                else if (layer.getLatLng) currentBounds = layer.getLatLng();

                updateUI();
            });

            mapInstance.on('draw:deleted', () => { currentBounds = null; updateUI(); });

            loadHistory();
        }

        function updateUI() {
            const count = drawnItems.getLayers().length;
            document.getElementById('analyze-btn').disabled = count === 0;
        }

        // --- SIDEBAR & TABS ---
        function toggleSidebar(show) {
            const sb = document.getElementById('left-sidebar');
            const showBtn = document.getElementById('show-sidebar-btn');
            if (show) {
                sb.classList.remove('sidebar-hidden');
                sb.classList.add('sidebar-visible');
                showBtn.classList.add('hidden');
            } else {
                sb.classList.add('sidebar-hidden');
                sb.classList.remove('sidebar-visible');
                showBtn.classList.remove('hidden');
            }
        }

        document.getElementById('close-sidebar').onclick = () => toggleSidebar(false);
        document.getElementById('show-sidebar-btn').onclick = () => toggleSidebar(true);
        document.getElementById('reset-btn').onclick = () => {
            drawnItems.clearLayers();
            currentBounds = null;
            toggleSidebar(false);
            updateUI();
        };

        // Tabs
        const btnCurrent = document.getElementById('tab-current');
        const btnHistory = document.getElementById('tab-history');
        const viewReport = document.getElementById('sidebar-report');
        const viewHistory = document.getElementById('sidebar-history');

        function switchTab(tab) {
            if (tab === 'current') {
                btnCurrent.className = "flex-1 text-[10px] font-bold uppercase py-1.5 rounded-lg bg-emerald-600 text-white shadow-md transition-all";
                btnHistory.className = "flex-1 text-[10px] font-bold uppercase py-1.5 rounded-lg text-slate-500 hover:text-slate-300 transition-all";
                viewReport.classList.remove('hidden');
                viewHistory.classList.add('hidden');
            } else {
                btnHistory.className = "flex-1 text-[10px] font-bold uppercase py-1.5 rounded-lg bg-emerald-600 text-white shadow-md transition-all";
                btnCurrent.className = "flex-1 text-[10px] font-bold uppercase py-1.5 rounded-lg text-slate-500 hover:text-slate-300 transition-all";
                viewHistory.classList.remove('hidden');
                viewReport.classList.add('hidden');
            }
        }
        btnCurrent.onclick = () => switchTab('current');
        btnHistory.onclick = () => switchTab('history');

        // --- PROVIDER SWITCHER NOTICE ---
        const providerSelect = document.getElementById('ai-provider');
        const xiaomiNotice = document.getElementById('xiaomi-notice');
        
        providerSelect.addEventListener('change', () => {
            if (providerSelect.value === 'xiaomi') {
                xiaomiNotice.classList.remove('hidden');
            } else {
                xiaomiNotice.classList.add('hidden');
            }
        });

        // --- HISTORY ---
        function saveToHistory(data) {
            let history = JSON.parse(localStorage.getItem('biofarm_history') || '[]');
            history.unshift({ timestamp: new Date().toLocaleString(), data: data });
            if (history.length > 10) history.pop();
            localStorage.setItem('biofarm_history', JSON.stringify(history));
            loadHistory();
        }

        function loadHistory() {
            const list = document.getElementById('sidebar-history');
            const history = JSON.parse(localStorage.getItem('biofarm_history') || '[]');
            if (history.length === 0) {
                list.innerHTML = `<p class="text-slate-500 text-xs italic text-center mt-10">No history available.</p>`;
                return;
            }
            list.innerHTML = '';

            history.forEach((item, index) => {
                // Safety: Check if data exists and has the expected structure
                if (!item.data || !item.data.crops || !item.data.crops.length || !item.data.soil) {
                    return; // Skip invalid history items
                }

                const data = item.data;
                const locName = data.location || "Unknown";

                const card = document.createElement('div');
                card.className = "glass-panel p-3 rounded-xl space-y-2 border-l-2 border-l-emerald-500/50 cursor-pointer group hover:bg-white/10 border-white/5";
                card.innerHTML = `
                    <div class="flex justify-between items-start">
                        <span class="text-[9px] text-emerald-400 font-bold uppercase group-hover:text-emerald-300 transition-colors">${item.timestamp}</span>
                        <span class="text-[9px] text-slate-400 px-1.5 py-0.5 rounded bg-white/5 truncate max-w-[100px]">${locName.split(',')[0]}</span>
                    </div>
                    <div class="grid grid-cols-2 gap-2 mt-1">
                        <div class="bg-black/20 p-1.5 rounded-lg text-center">
                            <span class="block text-[8px] text-slate-500 uppercase">Crop</span>
                            <span class="text-[10px] text-white font-bold">${data.crops[0].name}</span>
                        </div>
                        <div class="bg-black/20 p-1.5 rounded-lg text-center">
                            <span class="block text-[8px] text-slate-500 uppercase">Temp</span>
                            <span class="text-[10px] text-white font-bold">${data.climate ? data.climate.temperature + 'Â°C' : 'N/A'}</span>
                        </div>
                    </div>
                    <div class="hidden group-hover:block text-[8px] text-center text-emerald-400 font-bold uppercase tracking-widest bg-emerald-500/10 py-1 rounded">Click to View Details</div>
                `;

                // Add click handler to restore this report
                card.onclick = () => {
                    renderReport(item.data, item.data.location); // Restore report view
                    switchTab('current'); // Switch to view it
                };

                list.appendChild(card);
            });
        }

        // --- REUSABLE REPORT RENDERER ---
        function renderReport(data, locName) {
            reportData = data; // Ensure context is updated when viewing history/report
            const report = document.getElementById('sidebar-report');

            report.innerHTML = `
                <div class="animate-enter space-y-4">
                    <!-- Location Card -->
                    <div class="glass-panel p-4 rounded-2xl relative overflow-hidden group">
                        <div class="absolute top-0 right-0 p-3 opacity-10 group-hover:opacity-20 transition-opacity">
                            <i data-lucide="map" class="w-16 h-16 text-emerald-400"></i>
                        </div>
                        <div class="relative z-10">
                            <p class="text-[9px] text-emerald-400 font-bold uppercase tracking-widest mb-1">Target Zone</p>
                            <h3 class="text-base font-bold text-white mb-2 leading-tight">${locName}</h3>
                            <p class="text-[11px] text-slate-300 italic border-l-2 border-emerald-500/50 pl-2">
                                "${data.location_insight}"
                            </p>
                        </div>
                    </div>

                    <!-- Demographics & Climate Section -->
                    ${data.demographics || data.climate ? `
                    <div class="glass-panel p-4 rounded-2xl bg-gradient-to-br from-blue-500/5 to-purple-500/5 border-blue-500/20">
                        <h4 class="text-[10px] text-blue-300 font-bold uppercase tracking-wider mb-3 flex items-center gap-2">
                            <i data-lucide="users" class="w-3 h-3"></i> Regional Context
                        </h4>
                        <div class="grid grid-cols-2 gap-3">
                            ${data.demographics ? `
                            <div class="bg-black/20 p-2 rounded-lg">
                                <p class="text-[8px] text-slate-500 uppercase mb-1">Population Type</p>
                                <p class="text-[10px] text-white font-semibold">${data.demographics.population_type}</p>
                            </div>
                            <div class="bg-black/20 p-2 rounded-lg">
                                <p class="text-[8px] text-slate-500 uppercase mb-1">Primary Language</p>
                                <p class="text-[10px] text-white font-semibold">${data.demographics.language}</p>
                            </div>
                            ` : ''}
                            ${data.climate ? `
                            <div class="bg-black/20 p-2 rounded-lg">
                                <p class="text-[8px] text-slate-500 uppercase mb-1">Temperature</p>
                                <p class="text-[10px] text-cyan-400 font-bold">${data.climate.temperature}Â°C</p>
                            </div>
                            <div class="bg-black/20 p-2 rounded-lg">
                                <p class="text-[8px] text-slate-500 uppercase mb-1">Conditions</p>
                                <p class="text-[10px] text-white font-semibold">${data.climate.description}</p>
                            </div>
                            <div class="bg-black/20 p-2 rounded-lg">
                                <p class="text-[8px] text-slate-500 uppercase mb-1">Humidity</p>
                                <p class="text-[10px] text-blue-300 font-semibold">${data.climate.humidity}%</p>
                            </div>
                            <div class="bg-black/20 p-2 rounded-lg">
                                <p class="text-[8px] text-slate-500 uppercase mb-1">Wind Speed</p>
                                <p class="text-[10px] text-blue-300 font-semibold">${data.climate.wind_speed} m/s</p>
                            </div>
                            ${data.climate.sea_level ? `
                            <div class="bg-black/20 p-2 rounded-lg col-span-2">
                                <p class="text-[8px] text-slate-500 uppercase mb-1">Sea Level / Elevation</p>
                                <p class="text-[10px] text-emerald-400 font-bold">${data.climate.sea_level} meters</p>
                            </div>
                            ` : ''}
                            ` : ''}
                        </div>
                    </div>
                    ` : ''}

                    <!-- Soil Grid -->
                    <div>
                        <h4 class="text-[10px] text-slate-400 font-bold uppercase tracking-wider mb-2 flex items-center gap-2">
                            <i data-lucide="layers" class="w-3 h-3"></i> Soil Composition
                        </h4>
                        <div class="grid grid-cols-2 gap-2">
                            <div class="glass-panel p-3 rounded-xl bg-gradient-to-br from-white/5 to-transparent">
                                <p class="text-[9px] text-slate-500 uppercase">Type</p>
                                <p class="text-xs font-bold text-white mt-0.5">${data.soil.type}</p>
                            </div>
                            <div class="glass-panel p-3 rounded-xl">
                                <p class="text-[9px] text-slate-500 uppercase">pH Level</p>
                                <div class="flex items-center gap-2 mt-0.5">
                                    <span class="text-xs font-bold text-emerald-400">${data.soil.ph}</span>
                                    <div class="h-1.5 flex-1 bg-slate-700 rounded-full overflow-hidden">
                                        <div class="h-full bg-emerald-400" style="width: ${Math.min((parseFloat(data.soil.ph) / 14) * 100, 100)}%"></div>
                                    </div>
                                </div>
                            </div>
                            <div class="glass-panel p-3 rounded-xl col-span-2">
                                <p class="text-[9px] text-slate-500 uppercase mb-1.5">Nutrient Profile</p>
                                <div class="grid grid-cols-3 gap-2">
                                    <div class="bg-black/30 p-1.5 rounded text-center">
                                        <p class="text-[8px] text-slate-500">Nitrogen</p>
                                        <p class="text-[10px] text-emerald-300 font-bold">${data.soil.nitrogen || 'N/A'}</p>
                                    </div>
                                    <div class="bg-black/30 p-1.5 rounded text-center">
                                        <p class="text-[8px] text-slate-500">Phosphorus</p>
                                        <p class="text-[10px] text-blue-300 font-bold">${data.soil.phosphorus || 'N/A'}</p>
                                    </div>
                                    <div class="bg-black/30 p-1.5 rounded text-center">
                                        <p class="text-[8px] text-slate-500">Potassium</p>
                                        <p class="text-[10px] text-purple-300 font-bold">${data.soil.potassium || 'N/A'}</p>
                                    </div>
                                </div>
                            </div>
                            ${(data.soil.metals && data.soil.metals.length > 0) ? `
                            <div class="glass-panel p-3 rounded-xl col-span-2 bg-gradient-to-br from-orange-500/5 to-transparent border-orange-500/20">
                                <p class="text-[9px] text-orange-300 uppercase mb-2 font-bold flex items-center gap-1">
                                    <i data-lucide="atom" class="w-3 h-3"></i> Detected Metals
                                </p>
                                <div class="flex flex-wrap gap-1.5">
                                    ${data.soil.metals.map(metal => `
                                        <span class="bg-orange-500/20 text-orange-200 px-2 py-1 rounded-lg text-[9px] font-semibold border border-orange-500/30">
                                            ${metal}
                                        </span>
                                    `).join('')}
                                </div>
                            </div>
                            ` : ''}
                        </div>
                    </div>

                    <!-- Crops -->
                    <div>
                        <h4 class="text-[10px] text-slate-400 font-bold uppercase tracking-wider mb-2 flex items-center gap-2">
                            <i data-lucide="wheat" class="w-3 h-3"></i> Optimized Crops
                        </h4>
                        <div class="space-y-2">
                            ${data.crops.map((c, i) => `
                                <div class="glass-panel p-3 rounded-xl flex items-center justify-between group">
                                    <div class="flex items-center gap-3">
                                        <div class="w-8 h-8 rounded-lg ${i === 0 ? 'bg-emerald-500 text-white' : 'bg-slate-800 text-slate-400'} flex items-center justify-center font-bold text-xs">
                                            ${i + 1}
                                        </div>
                                        <div>
                                            <p class="text-xs font-bold text-white group-hover:text-emerald-300 transition-colors">${c.name}</p>
                                            <p class="text-[9px] text-slate-500 uppercase">${c.season}</p>
                                        </div>
                                    </div>
                                    <div class="text-right">
                                        <span class="text-xs font-bold ${i === 0 ? 'text-emerald-400' : 'text-slate-400'}">${c.match}%</span>
                                        <div class="w-12 h-1 bg-slate-700 rounded-full mt-1 ml-auto">
                                            <div class="h-full ${i === 0 ? 'bg-emerald-400' : 'bg-slate-500'}" style="width: ${c.match}%"></div>
                                        </div>
                                    </div>
                                </div>
                            `).join('')}
                        </div>
                    </div>

                    <!-- Water & Strategy -->
                    <div class="glass-panel p-4 rounded-2xl bg-gradient-to-b from-blue-500/10 to-transparent border-blue-500/20">
                        <h4 class="text-[10px] text-blue-300 font-bold uppercase tracking-wider mb-2 flex items-center gap-2">
                            <i data-lucide="droplets" class="w-3 h-3"></i> Irrigation Plan
                        </h4>
                        <div class="flex justify-between text-xs mb-3 text-blue-100">
                            <span>${data.water.quantity}</span>
                            <span class="opacity-70">${data.water.schedule}</span>
                        </div>
                        <div class="pt-3 border-t border-blue-500/20">
                            <p class="text-[11px] text-slate-300 italic leading-relaxed">"${data.strategy}"</p>
                        </div>
                    </div>
                </div>
            `;
            lucide.createIcons();
        }

        // --- API & ANALYSIS ---
        async function callOpenRouter(prompt) {
            let key = localStorage.getItem('biofarm_openrouter_key') || openRouterKey;

            const makeRequest = async (k) => {
                const response = await fetch("https://openrouter.ai/api/v1/chat/completions", {
                    method: "POST",
                    headers: {
                        "Authorization": `Bearer ${k}`,
                        "HTTP-Referer": siteUrl,
                        "X-Title": siteName,
                        "Content-Type": "application/json"
                    },
                    body: JSON.stringify({
                        "model": "xiaomi/mimo-v2-flash:free",
                        "messages": [{ "role": "user", "content": prompt }]
                    })
                });

                if (!response.ok) {
                    const errorText = await response.text();
                    // Check for 401 or specific error messages
                    if (response.status === 401 || errorText.includes("User not found")) {
                        throw new Error("AUTH_FAILED");
                    }
                    throw new Error(errorText);
                }
                return (await response.json()).choices[0].message.content;
            };

            try {
                return await makeRequest(key);
            } catch (e) {
                if (e.message === "AUTH_FAILED") {
                    throw e; // Propagate for UI handling
                }
                throw e;
            }
        }

        async function callXiaomi(prompt) {
            // Always use the local proxy for Xiaomi API
            const proxyUrl = "http://localhost:3001/proxy/xiaomi";
            
            try {
                const response = await fetch(proxyUrl, {
                    method: 'POST',
                    headers: {
                        'api-key': xiaomiKey,
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({
                        "model": "mimo-v2-flash",
                        "messages": [
                            { "role": "user", "content": prompt }
                        ],
                        "thinking": { "type": "disabled" }
                    })
                });
                
                if (!response.ok) {
                    const errorText = await response.text();
                    throw new Error(errorText);
                }
                
                return (await response.json()).choices[0].message.content;
            } catch (e) {
                // If proxy connection fails
                if (e.message.includes('Failed to fetch') || e.message.includes('ERR_CONNECTION_REFUSED')) {
                    throw new Error("PROXY_NOT_RUNNING");
                }
                throw e;
            }
        }

        async function callAI(prompt) {
            const provider = document.getElementById('ai-provider').value;
            console.log("Using Provider:", provider);

            if (provider === 'xiaomi') {
                try {
                    return await callXiaomi(prompt);
                } catch (e) {
                    if (e.message === "PROXY_NOT_RUNNING") {
                        console.warn("Xiaomi proxy not running, using OpenRouter for this request (keeping Xiaomi selected)");
                        // Fallback to OpenRouter but DON'T change the dropdown
                        return await callOpenRouter(prompt);
                    }
                    throw e;
                }
            } else {
                return await callOpenRouter(prompt);
            }
        }

        async function reverseGeocode(lat, lon) {
            try {
                // Using BigDataCloud API to avoid CORS issues with Nominatim
                const res = await fetch(`https://api.bigdatacloud.net/data/reverse-geocode-client?latitude=${lat}&longitude=${lon}&localityLanguage=en`);
                const data = await res.json();

                // Extract meaningful location name
                // Order of preference: Locality -> City -> Town -> Village -> Principal Subdivision
                const name = data.locality || data.city || data.town || data.village || data.principalSubdivision || "Unknown Location";
                const state = data.principalSubdivision || "";

                // Format display name
                const displayName = state && name !== state ? `${name}, ${state}` : name;

                return { name, displayName: displayName || `${lat.toFixed(4)}, ${lon.toFixed(4)}` };
            } catch (e) {
                console.warn("Geocoding failed, falling back to coords", e);
                return { name: "Unknown", displayName: `${lat.toFixed(4)}, ${lon.toFixed(4)}` };
            }
        }

        document.getElementById('analyze-btn').onclick = async () => {
            if (!currentBounds) return;

            const btn = document.getElementById('analyze-btn');
            const btnText = document.getElementById('analyze-text');
            const report = document.getElementById('sidebar-report');

            btn.disabled = true;
            btnText.innerText = "Locating...";
            toggleSidebar(true);
            switchTab('current');

            report.innerHTML = `
                <div class="flex flex-col items-center justify-center h-64 animate-pulse">
                    <div class="w-12 h-12 rounded-full border-4 border-emerald-500/20 border-t-emerald-500 animate-spin mb-4"></div>
                    <p class="text-xs text-emerald-400 font-bold tracking-widest uppercase">Scanning Satellite Data...</p>
                    <p class="text-[10px] text-slate-500 mt-2">Connecting to AI Grid...</p>
                </div>
            `;

            try {
                const { lat, lng } = currentBounds;
                const loc = await reverseGeocode(lat, lng);
                const locName = loc.displayName;

                btnText.innerText = "Analyzing...";
                report.innerHTML = `
                    <div class="flex flex-col items-center justify-center h-64 animate-pulse">
                        <i data-lucide="map-pin" class="text-emerald-400 mb-2 w-8 h-8"></i>
                        <p class="text-xs text-white font-bold">${locName}</p>
                        <p class="text-[10px] text-slate-500 mt-1">Processing Soil Metrics...</p>
                    </div>
                `;
                lucide.createIcons();

                const prompt = `
                    Act as an expert Agronomist and Geographer AI. 
                    Target Location: "${locName}" (${lat}, ${lng}).
                    
                    TASK:
                    1. Check if location is WATER/OCEAN. If yes, return {"error": "Target is a water body."}.
                    2. If LAND, return JSON:
                    {
                        "location_insight": "One engaging sentence about agriculture/geography here.",
                        "demographics": {
                            "population_type": "Rural/Urban/Suburban description",
                            "language": "Primary language spoken in this region"
                        },
                        "climate": {
                            "temperature": "Current temp estimate",
                            "description": "Weather condition",
                            "humidity": "Humidity %",
                            "wind_speed": "Wind speed",
                            "sea_level": "Elevation in meters above sea level"
                        },
                        "soil": {
                            "type": "Soil Type Name",
                            "ph": "pH Value (e.g. 6.5)",
                            "nitrogen": "Level (Low/Med/High)",
                            "phosphorus": "Level",
                            "potassium": "Level",
                            "metals": ["Iron", "Aluminum", "Copper", "Zinc"], 
                            "moisture": "Percentage"
                        },
                        "water": {
                            "quantity": "Liters/ha",
                            "schedule": "Schedule (e.g. Weekly)",
                            "source": "Source"
                        },
                        "crops": [
                            { "name": "Best Crop", "match": 98, "season": "Season" },
                            { "name": "Alt Crop 1", "match": 85, "season": "Season" },
                            { "name": "Alt Crop 2", "match": 72, "season": "Season" }
                        ],
                        "strategy": "A concise expert strategy paragraph."
                    }
                    Note: For metals array, list common soil metals found in this region. For climate data, provide realistic estimates based on the location.
                `;

                // Use wrapper to pick provider
                const raw = await callAI(prompt);
                const data = JSON.parse(raw.replace(/```json/g, '').replace(/```/g, '').trim());

                if (data.error) {
                    report.innerHTML = `
                        <div class="glass-panel p-6 rounded-2xl text-center border-red-500/30 bg-red-500/5">
                            <i data-lucide="alert-octagon" class="w-10 h-10 text-red-400 mx-auto mb-3"></i>
                            <h3 class="text-white font-bold mb-1">Analysis Halted</h3>
                            <p class="text-red-300 text-xs mb-4">${data.error}</p>
                            <div class="bg-black/20 p-2 rounded text-[10px] font-mono text-slate-400">${locName}</div>
                        </div>`;
                } else {
                    // Inject location name into data object for history
                    data.location = locName;

                    reportData = data; // Save for Chat Context
                    saveToHistory(data);
                    renderReport(data, locName);
                }
            } catch (e) {
                console.error(e);
                if (e.message === "AUTH_FAILED") {
                    report.innerHTML = `
                        <div class="glass-panel p-6 rounded-2xl text-center border-orange-500/30 bg-orange-500/5">
                            <div class="w-12 h-12 rounded-full bg-orange-500/20 flex items-center justify-center mx-auto mb-3 animate-pulse">
                                <i data-lucide="key" class="w-6 h-6 text-orange-400"></i>
                            </div>
                            <h3 class="text-white font-bold mb-1">API Key Required</h3>
                            <p class="text-orange-200/80 text-xs mb-4">The default API key has expired or is invalid. Please enter your OpenRouter API Key to continue.</p>
                            
                            <input type="password" id="custom-api-key" placeholder="sk-or-v1-..." 
                                class="w-full bg-black/40 border border-orange-500/30 rounded-lg px-3 py-2 text-xs text-white placeholder:text-slate-600 focus:outline-none focus:border-orange-500 mb-3 text-center font-mono"
                            >
                            
                            <button id="save-key-btn" class="w-full bg-orange-500 hover:bg-orange-400 text-white font-bold uppercase text-[10px] tracking-widest py-2.5 rounded-lg transition-colors shadow-lg shadow-orange-900/20">
                                Save & Retry
                            </button>
                            
                            <p class="text-[9px] text-slate-500 mt-3">Key is stored locally in your browser.</p>
                        </div>
                    `;
                    lucide.createIcons();

                    document.getElementById('save-key-btn').onclick = () => {
                        const newKey = document.getElementById('custom-api-key').value.trim();
                        if (newKey) {
                            localStorage.setItem('biofarm_openrouter_key', newKey);
                            document.getElementById('analyze-btn').click(); // Retry
                        }
                    };
                } else if (e.message === "PROXY_NOT_RUNNING") {
                    report.innerHTML = `
                        <div class="glass-panel p-6 rounded-2xl text-center border-yellow-500/30 bg-yellow-500/5">
                            <div class="w-12 h-12 rounded-full bg-yellow-500/20 flex items-center justify-center mx-auto mb-3">
                                <i data-lucide="server-off" class="w-6 h-6 text-yellow-400"></i>
                            </div>
                            <h3 class="text-white font-bold mb-2">Xiaomi API Connection Failed</h3>
                            <p class="text-yellow-200/80 text-xs mb-4">CORS restriction detected. Start the proxy server to fix this.</p>
                            
                            <div class="bg-black/30 p-4 rounded-lg text-left mb-4 space-y-2">
                                <p class="text-[10px] text-emerald-400 font-bold">ðŸš€ Quick Fix:</p>
                                <ol class="text-[9px] text-slate-300 space-y-1 ml-4 list-decimal">
                                    <li>Double-click <code class="bg-black/40 px-1 rounded text-emerald-400">start-proxy.bat</code></li>
                                    <li>Wait for "Proxy running" message</li>
                                    <li>Keep window open & retry</li>
                                </ol>
                                <p class="text-[9px] text-slate-500 mt-2">Or run: <code class="text-emerald-400">node local-proxy.js</code></p>
                            </div>
                            
                            <div class="flex gap-2">
                                <button id="retry-xiaomi" class="flex-1 bg-yellow-500 hover:bg-yellow-400 text-black font-bold uppercase text-[10px] tracking-widest py-2.5 rounded-lg transition-colors">
                                    Retry Xiaomi
                                </button>
                                <button id="switch-openrouter" class="flex-1 bg-emerald-500 hover:bg-emerald-400 text-white font-bold uppercase text-[10px] tracking-widest py-2.5 rounded-lg transition-colors">
                                    Use OpenRouter
                                </button>
                            </div>
                            
                            <p class="text-[8px] text-slate-600 mt-3">See PROXY_SETUP.md for detailed instructions</p>
                        </div>
                    `;
                    lucide.createIcons();
                    document.getElementById('retry-xiaomi').onclick = () => {
                        document.getElementById('analyze-btn').click();
                    };
                    document.getElementById('switch-openrouter').onclick = () => {
                        // Only switch if user explicitly clicks this button
                        document.getElementById('ai-provider').value = 'openrouter';
                        xiaomiNotice.classList.add('hidden');
                        document.getElementById('analyze-btn').click();
                    };
                } else {
                    report.innerHTML = `<div class="p-4 text-center text-red-400 text-xs">Analysis Failed. Network/Quota Issue.<br><span class="text-[9px] text-slate-500 font-mono mt-1 block">${e.message.slice(0, 50)}...</span></div>`;
                }
            }

            btnText.innerText = "Analyze Field";
            btn.disabled = false;
        };

        // --- CHAT ---
        async function handleChat() {
            const input = document.getElementById('chat-input');
            const box = document.getElementById('chat-box');
            const q = input.value.trim();
            if (!q) return;

            box.innerHTML += `
                <div class="flex gap-3 flex-row-reverse animate-enter">
                    <div class="w-6 h-6 rounded-full bg-slate-700 flex items-center justify-center shrink-0">
                        <i data-lucide="user" class="w-3 h-3 text-slate-400"></i>
                    </div>
                    <div class="bg-emerald-600 p-3 rounded-2xl rounded-tr-none text-white shadow-sm text-right">
                        ${q}
                    </div>
                </div>`;
            input.value = "";
            box.scrollTop = box.scrollHeight;
            lucide.createIcons();

            let ctx = currentBounds ? `Field Loc: ${currentBounds.lat.toFixed(4)},${currentBounds.lng.toFixed(4)}` : "General";

            // Add full analysis context if available
            if (reportData) {
                ctx += `\nANALYSIS DATA: ${JSON.stringify(reportData)}`;
            }

            try {
                // Use wrapper to pick provider
                const ans = await callAI(`Act as expert farmer. Q: "${q}". Context: ${ctx}. Keep it short.`);
                box.innerHTML += `
                    <div class="flex gap-3 animate-enter">
                        <div class="w-6 h-6 rounded-full bg-emerald-500/20 flex items-center justify-center shrink-0 border border-emerald-500/30">
                            <i data-lucide="bot" class="w-3 h-3 text-emerald-400"></i>
                        </div>
                        <div class="bg-white/10 p-3 rounded-2xl rounded-tl-none border border-white/10 text-slate-200 shadow-sm prose prose-invert prose-xs max-w-none">
                            ${marked.parse(ans)}
                        </div>
                    </div>`;
            } catch (e) {
                box.innerHTML += `<div class="text-red-400 text-xs text-center mt-2">Error connecting.</div>`;
            }
            box.scrollTop = box.scrollHeight;
            lucide.createIcons();
        }

        document.getElementById('send-chat').onclick = handleChat;
        document.getElementById('chat-input').onkeypress = (e) => { if (e.key === 'Enter') handleChat(); };

        // Chat Toggle
        const win = document.getElementById('chat-window');
        document.getElementById('toggle-chat-btn').onclick = () => {
            win.classList.remove('chat-hidden');
            win.classList.add('chat-visible');
            // Auto focus input
            setTimeout(() => document.getElementById('chat-input').focus(), 100);
        };
        document.getElementById('close-chat').onclick = () => { win.classList.add('chat-hidden'); win.classList.remove('chat-visible'); };

        initMap();
    </script>
</body>

</html>